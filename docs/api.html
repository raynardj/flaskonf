---

title: API Core

keywords: fastai
sidebar: home_sidebar

summary: "core part of API"
description: "core part of API"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/10_api.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s2">&quot;test_flaskon&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Helper-Functions">Helper Functions<a class="anchor-link" href="#Helper-Functions"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="open_json" class="doc_header"><code>open_json</code><a href="https://github.com/raynardj/flaskonf/tree/master/flaskonf/api.py#L17" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>open_json</code>(<strong><code>path</code></strong>:<code>Path</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="open_file" class="doc_header"><code>open_file</code><a href="https://github.com/raynardj/flaskonf/tree/master/flaskonf/api.py#L21" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>open_file</code>(<strong><code>path</code></strong>:<code>Path</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="mkdir" class="doc_header"><code>mkdir</code><a href="https://github.com/raynardj/flaskonf/tree/master/flaskonf/api.py#L25" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>mkdir</code>(<strong><code>path</code></strong>:<code>Path</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="clean_up_string" class="doc_header"><code>clean_up_string</code><a href="https://github.com/raynardj/flaskonf/tree/master/flaskonf/api.py#L28" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>clean_up_string</code>(<strong><code>x</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="error_printer" class="doc_header"><code>error_printer</code><a href="https://github.com/raynardj/flaskonf/tree/master/flaskonf/api.py#L34" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>error_printer</code>(<strong><code>e</code></strong>:<code>Exception</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="time_str" class="doc_header"><code>time_str</code><a href="https://github.com/raynardj/flaskonf/tree/master/flaskonf/api.py#L38" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>time_str</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Directory-management">Directory management<a class="anchor-link" href="#Directory-management"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Directories" class="doc_header"><code>class</code> <code>Directories</code><a href="https://github.com/raynardj/flaskonf/tree/master/flaskonf/api.py#L42" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Directories</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Flaskonf-coref-components">Flaskonf coref components<a class="anchor-link" href="#Flaskonf-coref-components"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FlaskonfAPI" class="doc_header"><code>class</code> <code>FlaskonfAPI</code><a href="https://github.com/raynardj/flaskonf/tree/master/flaskonf/api.py#L93" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FlaskonfAPI</code>(<strong><code>import_name</code></strong>, <strong><code>static_url_path</code></strong>=<em><code>None</code></em>, <strong><code>static_folder</code></strong>=<em><code>'static'</code></em>, <strong><code>static_host</code></strong>=<em><code>None</code></em>, <strong><code>host_matching</code></strong>=<em><code>False</code></em>, <strong><code>subdomain_matching</code></strong>=<em><code>False</code></em>, <strong><code>template_folder</code></strong>=<em><code>'templates'</code></em>, <strong><code>instance_path</code></strong>=<em><code>None</code></em>, <strong><code>instance_relative_config</code></strong>=<em><code>False</code></em>, <strong><code>root_path</code></strong>=<em><code>None</code></em>) :: <code>Flask</code></p>
</blockquote>
<h1 id="create-an-flask-app">create an flask app<a class="anchor-link" href="#create-an-flask-app"> </a></h1><p>app = FlaskonAPI("alpha_api")</p>
<h1 id="assign-address-for-directories-full-of-json">assign address for directories full of json<a class="anchor-link" href="#assign-address-for-directories-full-of-json"> </a></h1><p>app.build_on_config(
    confs_dir="../tests/confs/",
    examples_dir="../tests/examples/"
    )</p>
<h1 id="create-an-api-blueprint">create an api blueprint<a class="anchor-link" href="#create-an-api-blueprint"> </a></h1><h1 id="with-such-blueprint,-we-can-have-an-api-for-each-configuration-file">with such blueprint, we can have an api for each configuration file<a class="anchor-link" href="#with-such-blueprint,-we-can-have-an-api-for-each-configuration-file"> </a></h1><p>@app.conf_route("/guide/")
def build_city_guide(conf_file: str, conf: Dict):
    logging.info(f"{conf}")
    def guide_api(data: Dict):
        user = data["user"]
        return {"city_data": conf, "user": user}
    return guide_api</p>
<h1 id="run-api">run api<a class="anchor-link" href="#run-api"> </a></h1><p>app.run('0.0.0.0', port=1234)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">FlaskonfAPI</span><span class="p">(</span><span class="s2">&quot;test_flaskonf&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Configuration directory</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ls ../tests/confs/
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>la.json       shanghai.json
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Example directory</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ls ../tests/examples/guide_shanghai
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>eg_201229_180805.json eg_201229_182134.json print_all.json
eg_201229_181208.json eg_210506_125048.json
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>cat ../tests/examples/guide_shanghai/print_all.json
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{
    &#34;user&#34;:&#34;admin&#34;
}</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">app</span><span class="o">.</span><span class="n">build_on_config</span><span class="p">(</span><span class="n">confs_dir</span><span class="o">=</span><span class="s2">&quot;../tests/confs/&quot;</span><span class="p">,</span><span class="n">examples_dir</span><span class="o">=</span><span class="s2">&quot;../tests/examples/&quot;</span> <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="No-build-option">No build option<a class="anchor-link" href="#No-build-option"> </a></h3><blockquote><p>set <code>nobuild=False</code> you can build APIs with configuration in batch</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">conf_route</span><span class="p">(</span><span class="s2">&quot;/guide2/&quot;</span><span class="p">,</span> <span class="n">nobuild</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">guide_api</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;city_data2&quot;</span><span class="p">:</span> <span class="n">conf</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="With-Build">With Build<a class="anchor-link" href="#With-Build"> </a></h3><blockquote><p>If you want to load huge things to memory according to configuration, eg. load different transfromers with configuration</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">conf_route</span><span class="p">(</span><span class="s2">&quot;/guide/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">build_city_guide</span><span class="p">(</span><span class="n">conf_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># doing other things for building API here</span>
    <span class="c1"># like load huge model into memory with configuration</span>
    <span class="k">def</span> <span class="nf">guide_api</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;city_data&quot;</span><span class="p">:</span> <span class="n">conf</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">guide_api</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">app</span><span class="o">.</span><span class="n">build_flaskonf</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:root:{&#39;name&#39;: &#39;Los Angeles&#39;, &#39;country&#39;: &#39;United States&#39;, &#39;sites&#39;: [&#39;universal studio&#39;, &#39;griffith observatory&#39;, &#39;union station&#39;]}
INFO:root:run config	la.json on route	/guide/la/
INFO:root:{&#39;name&#39;: &#39;Shanghai&#39;, &#39;country&#39;: &#39;China&#39;, &#39;sites&#39;: [&#39;french concession&#39;, &#39;xin tiandi&#39;, &#39;disney resort&#39;]}
INFO:root:run config	shanghai.json on route	/guide/shanghai/
INFO:root:run config	la.json on route	/guide2/la/
INFO:root:run config	shanghai.json on route	/guide2/shanghai/
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">9727</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> * Serving Flask app &#34;test_flaskonf&#34; (lazy loading)
 * Environment: production
   WARNING: This is a development server. Do not use it in a production deployment.
   Use a production WSGI server instead.
 * Debug mode: off
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:werkzeug: * Running on http://0.0.0.0:9727/ (Press CTRL+C to quit)
DEBUG:root:loading examples from ../tests/examples/guide_la
INFO:werkzeug:127.0.0.1 - - [06/May/2021 12:53:20] &#34;<span class="ansi-white-fg">GET /guide/la/ HTTP/1.1</span>&#34; 200 -
ERROR:root:Traceback (most recent call last):
  File &#34;&lt;ipython-input-19-24a00b29e23c&gt;&#34;, line 111, in wrapper
    result = f(inputs)
  File &#34;&lt;ipython-input-25-32c7827afe5e&gt;&#34;, line 8, in guide_api
    user = data[&#34;user&#34;]
KeyError: &#39;user&#39;

INFO:werkzeug:127.0.0.1 - - [06/May/2021 12:54:05] &#34;<span class="ansi-magenta-intense-fg ansi-bold">POST /guide/la/ HTTP/1.1</span>&#34; 500 -
INFO:werkzeug:127.0.0.1 - - [06/May/2021 12:54:37] &#34;<span class="ansi-white-fg">POST /guide/la/ HTTP/1.1</span>&#34; 200 -
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

